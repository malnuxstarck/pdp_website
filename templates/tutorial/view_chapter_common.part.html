{% load markup %}
{% load emarkdown %}

{% with extracts=chapter.get_extracts %}
    <div class="row">
        <div class="large-12 columns">
            {% if not chapter.tutorial %}
                {% if chapter.introduction %}
                    {{ chapter.introduction|emarkdown }}
                {% else %}
                    <p>Aucune introduction.</p>
                {% endif %}
            {% endif %}

            {% if extracts %}
                <ul>
                    {% for extract in extracts %}
                        <li>
                            <a href="#{{ extract.position_in_chapter }}-{{ extract.title|slugify }}">
                                {{ extract.title }}
                            </a>
                        </li>
                    {% endfor %}
                </ul>
            {% else %}
                <p>
                    Aucun extrait.
                </p>
            {% endif %}
        </div>
    </div>

    {% if user in authors and not tutorial.is_mini %}
    <div class="row">
        <div class="large-12 columns">
            <a href="/tutoriels/nouveau/extrait?chapitre={{ chapter.pk }}" class="button">
                <i class="icon-plus"></i>
                Ajouter
            </a>
        </div>
    </div>
    {% endif %}

    <hr />

    {% for extract in extracts %}
    <div class="row">
        <div class="large-12 columns">
            <h2 id="{{ extract.position_in_chapter }}-{{ extract.title|slugify }}">
                <a href="#{{ extract.position_in_chapter }}-{{ extract.title|slugify }}">
                    {{ extract.title }}
                </a>
            </h2>

            {% if user in authors %}
                <form action="{% url "pdp.tutorial.views.modify_extract" %}" method="post">
                    <div class="button-group">
                        <a href="{% url "pdp.tutorial.views.edit_extract" %}?extrait={{ extract.pk }}" class="button">
                            <i class="icon-pencil"></i>
                            Éditer
                        </a>
                        <a href="#" class="button secondary" data-dropdown="extract-{{ extract.pk }}">
                            <i class="icon-move"></i>
                            Déplacer
                        </a>
                        <div id="extract-{{ extract.pk }}" class="f-dropdown content" data-dropdown-content>
                            <select name="move_target">
                                {% if extract.position_in_chapter > 1 %}
                                    <option value="{{ extract.position_in_chapter|add:"-1" }}">Monter</option>
                                {% endif %}
                                {% if extract.position_in_chapter < chapter.get_extracts.count %}
                                    <option value="{{ extract.position_in_chapter|add:"1" }}">Descendre</option>
                                {% endif %}
                                    <option disabled>&mdash; Déplacer avant</option>
                                {% for extract_mv in chapter.get_extracts %}
                                    {% if extract != extract_mv and extract_mv.position_in_chapter|add:"-1" != extract.position_in_chapter %}
                                    <option value="{% if extract_mv.position_chapter < extract.position_in_chapter %}{{ extract_mv.position_in_chapter }}{% else %}{{ extract_mv.position_in_chapter|add:"-1" }}{% endif %}">
                                        Extrait {{ extract_mv.position_in_chapter }} : {{ extract_mv.title }}
                                    </option>
                                    {% endif %}
                                {% endfor %}
                                <option disabled>&mdash; Déplacer après</option>
                                {% for extract_mv in chapter.get_extracts %}
                                    {% if extract != extract_mv and extract_mv.position_in_chapter|add:"1" != extract.position_in_chapter %}
                                    <option value="{% if extract_mv.position_chapter < extract.position_in_chapter %}{{ extract_mv.position_in_chapter|add:"1" }}{% else %}{{ extract_mv.position_in_chapter }}{% endif %}">
                                        Extrait {{ extract_mv.position_in_chapter }} : {{ extract_mv.title }}
                                    </option>
                                    {% endif %}
                                {% endfor %}
                            </select>
                            <button type="submit" name="move" class="button">
                                Déplacer
                            </button>
                        </div>
                        <button type="submit" name="delete" class="button secondary">
                            <i class="icon-remove"></i>
                            Supprimer
                        </button>
                    </div>
                    <input type="hidden" name="extract" value="{{ extract.pk }}" />
                    {% csrf_token %}
                </form>
            {% endif %}

            {% if extract.text %}
                {{ extract.text|emarkdown }}
            {% else %}
                <p>
                    Cet extrait est vide.
                </p>
            {% endif %}
        </div>
    </div>
    {% endfor %}

    <hr />

    {% if not chapter.tutorial %}
    <div class="row">
        <div class="large-12 columns">
            {% if chapter.conclusion %}
                {{ chapter.conclusion|emarkdown }}
            {% else %}
                <p>Aucune conclusion.</p>
            {% endif %}
        </div>
    </div>
    {% endif %}

{% endwith %}
