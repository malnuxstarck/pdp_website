{# Block displaying a chapter (for large and small tutorials) #}
{% load markup %}

{% if user in chapter.part.tutorial.authors.all or user in chapter.tutorial.authors.all %}
<p>
    <form action="{% url pdp.tutorial.views.modify_chapter %}" method="POST">
    <a href="/tutoriels/nouveau/extrait?chapitre={{ chapter.pk }}" class="btn">
        <i class="icon-plus"></i>
        Ajouter un extrait
    </a>

    <div class="btn-group">
        <a href="/tutoriels/editer/chapitre?chapitre={{ chapter.pk }}" class="btn">
            <i class="icon-pencil"></i>
            Éditer le chapitre
        </a>

        {# Part deletion is only available for large tutorials #}
        {% if chapter.part %}
        <button type="submit" name="delete" class="btn">
            <i class="icon-remove"></i>
            Supprimer le chapitre
        </button>
        {% endif %}
    </div>

    <input type="hidden" name="chapter" value="{{ chapter.pk }}" />
    {% csrf_token %}
    </form>
</p>
{% endif %}

{% if chapter.introduction %}
{{ chapter.introduction|markdown:"safe,codehilite,extra" }}
{% else %}
<p>Aucune introduction.</p>
{% endif %}

<div>
    {% if chapter.get_extracts %}
    <ul>
    {% for extract in chapter.get_extracts %}
        <li>
            <a href="#{{ extract.position_in_chapter }}-{{ extract.title|slugify }}">
                {{ extract.title }}
            </a>
        </li>
    {% endfor %}
    </ul>
    {% else %}
    <p>
        Aucun extrait.
    </p>
    {% endif %}
</div>

<hr />

{% for extract in chapter.get_extracts %}
    <h2 id="{{ extract.position_in_chapter }}-{{ extract.title|slugify }}">{{ extract.title }}</h2>

    {% if user in chapter.part.tutorial.authors.all or user in chapter.tutorial.authors.all %}
    <p>
        <form action="{% url pdp.tutorial.views.modify_extract %}" method="POST">

        <div class="btn-group">
            <a href="{% url pdp.tutorial.views.edit_extract %}?extrait={{ extract.pk }}" class="btn">
                <i class="icon-pencil"></i>
                Éditer l'extrait
            </a>
            <button type="submit" name="delete" class="btn">
                <i class="icon-remove"></i>
                Supprimer l'extrait
            </button>
        </div>

        <input type="hidden" name="extract" value="{{ extract.pk }}" />
        {% csrf_token %}
        </form>
    </p>
    {% endif %}

    {% if extract.text %}
        {{ extract.text|markdown:"safe,codehilite,extra" }}
    {% else %}
    <p>
        Cet extrait est vide.
    </p>
    {% endif %}
{% endfor %}

<hr />

{% if chapter.conclusion %}
{{ chapter.conclusion|markdown:"safe,codehilite,extra" }}
{% else %}
<p>Aucune conclusion.</p>
{% endif %}
